<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WillBoot-PRO ‚Ä¢ Aviator IA</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { background:#050505; font-family:sans-serif; color:white; }
  .glass { background:rgba(255,255,255,0.04); backdrop-filter:blur(16px); border-radius:16px; }
  .neon-red { box-shadow:0 0 25px rgba(220,38,38,.6); }
  .btn-red { background:#dc2626; padding:12px 24px; border-radius:12px; font-weight:bold; cursor:pointer; transition:0.3s; }
  .btn-red:hover { background:#b91c1c; }
  .btn-gray { background:#111; padding:12px 24px; border-radius:12px; font-weight:bold; cursor:pointer; transition:0.3s; }
  .btn-gray:hover { background:#222; }
  .signal-card { padding:16px; border-radius:12px; text-align:center; transition:0.3s; }
</style>
</head>
<body>

<!-- ========================= P√°gina 1: Acesso ao Site ========================= -->
<div id="page1" class="min-h-screen flex items-center justify-center">
  <div class="glass p-10 w-full max-w-md border border-red-600/30">
    <h1 class="text-3xl font-black text-red-600 mb-6 text-center">WILLBOOT-PRO</h1>
    <input id="userMain" placeholder="Usu√°rio" class="w-full mb-4 p-3 rounded bg-black border border-gray-700">
    <input id="passMain" type="password" placeholder="Senha" class="w-full mb-6 p-3 rounded bg-black border border-gray-700">
    <button class="btn-red w-full neon-red mb-4" onclick="loginMain()">üîê ENTRAR</button>
    <p class="text-center text-gray-400 text-sm">Acesso normal ao site</p>
  </div>
</div>

<!-- ========================= P√°gina 2: Dashboard Normal ========================= -->
<div id="page2" class="hidden max-w-7xl mx-auto px-6 py-10">
  <!-- Header -->
  <div class="glass p-6 flex flex-col md:flex-row justify-between items-center border border-red-600/20 mb-6">
    <div id="clock2" class="text-red-500 font-bold"></div>
    <div class="flex gap-4 mt-4 md:mt-0">
      <button class="btn-red" onclick="generateSignalsPage2()">üî• GERAR SINAIS</button>
      <button class="btn-gray" onclick="logoutMain()">üö™ SAIR</button>
    </div>
  </div>

  <!-- Sinais -->
  <div id="signalsPage2" class="grid md:grid-cols-3 gap-6 my-10"></div>

  <!-- Escolha de casas de apostas -->
  <div class="glass p-6 mb-6 border border-red-600/20">
    <label class="mb-2 block font-bold">Escolha a Casa de Aposta:</label>
    <select id="betHouse" class="w-full p-3 rounded bg-black border border-gray-700">
      <option value="ElephantBet">ElephantBet</option>
      <option value="BantuBet">BantuBet</option>
      <option value="888Bet">888Bet</option>
      <option value="TopAposta">TopAposta</option>
    </select>
  </div>

  <!-- Gr√°fico -->
  <div class="glass p-6 rounded-xl border border-red-600/20">
    <h3 class="text-center font-bold mb-4">üìä Performance IA (Hist√≥rico Real)</h3>
    <canvas id="chartPage2" height="120"></canvas>
  </div>

  <!-- Acesso VIP -->
  <div class="glass p-8 mt-10 border border-red-600/30 text-center">
    <h2 class="text-2xl font-black text-red-600 mb-4">üíé ACESSO VIP</h2>
    <p class="text-gray-300 mb-4">Sinais ROSA de alta probabilidade ‚Ä¢ IA treinada com hist√≥rico real</p>
    <input id="vipUser" placeholder="Usu√°rio VIP" class="w-full mb-2 p-3 rounded bg-black border border-gray-700">
    <input id="vipPass" type="password" placeholder="Senha VIP" class="w-full mb-4 p-3 rounded bg-black border border-gray-700">
    <button class="btn-red neon-red w-full" onclick="loginVIP()">üîê ENTRAR VIP</button>
  </div>

  <!-- Upload de hist√≥rico Aviator no final -->
  <div class="glass p-6 mb-6 mt-10 border border-red-600/20 text-center">
    <label class="block mb-2 font-bold">Enviar hist√≥rico Aviator (PNG/JPG)</label>
    <input type="file" id="uploadHistory" accept="image/*" class="mb-4">
    <button class="btn-red neon-red" onclick="analyzeHistory()">üìä ANALISAR</button>
    <p id="historyResult" class="mt-2 text-gray-300"></p>
  </div>
</div>

<!-- ========================= P√°gina 3: VIP ========================= -->
<div id="page3" class="hidden max-w-7xl mx-auto px-6 py-10">
  <h1 class="text-3xl font-black text-red-600 mb-6 text-center">üíé VIP - Sinais ROSA</h1>

  <!-- Hor√°rio -->
  <div class="glass p-4 mb-6 text-center border border-red-600/20">
    <div id="clock3" class="text-red-500 font-bold"></div>
  </div>

  <!-- Sinais ROSA -->
  <div id="signalsVIP" class="grid md:grid-cols-3 gap-6 my-6"></div>

  <!-- Gr√°fico VIP -->
  <div class="glass p-6 rounded-xl border border-red-600/20">
    <h3 class="text-center font-bold mb-4">üìä Performance VIP (Aviator)</h3>
    <canvas id="chartVIP" height="120"></canvas>
  </div>

  <div class="glass p-6 mt-6 text-center border border-red-600/30">
    <p class="text-gray-300">Usu√°rio VIP: William | Passe: 230220</p>
  </div>

  <!-- Upload de hist√≥rico Aviator VIP no final -->
  <div class="glass p-6 mb-6 mt-10 border border-red-600/20 text-center">
    <label class="block mb-2 font-bold">Enviar hist√≥rico Aviator VIP (PNG/JPG)</label>
    <input type="file" id="uploadHistoryVIP" accept="image/*" class="mb-4">
    <button class="btn-red neon-red" onclick="analyzeHistoryVIP()">üìä ANALISAR VIP</button>
    <p id="historyResultVIP" class="mt-2 text-gray-300"></p>
  </div>
</div>

<script>
/** =========================================================
 *  CONFIG
 *  ========================================================= */
const BACKEND_URL = "const BACKEND_URL = "https://willboot-backend-1.onrender.com";


/** =========================================================
 *  Rel√≥gios
 *  ========================================================= */
setInterval(()=>{
  const now = new Date().toLocaleString("pt-PT",{timeZone:"Africa/Luanda"});
  if(document.getElementById("clock2")) clock2.innerHTML="üïê "+now;
  if(document.getElementById("clock3")) clock3.innerHTML="üïê "+now;
},1000);

/** =========================================================
 *  Login
 *  ========================================================= */
function loginMain(){
  const u=userMain.value, p=passMain.value;
  if(u && p){
    localStorage.setItem("mainAccess","true");
    document.getElementById("page1").classList.add("hidden");
    document.getElementById("page2").classList.remove("hidden");
    loadHistoryPage2();
  }
}
function logoutMain(){
  localStorage.removeItem("mainAccess");
  location.reload();
}
if(localStorage.getItem("mainAccess")) loginMain();

/** =========================================================
 *  Helpers para ler JSON do backend (compat√≠vel com chaves diferentes)
 *  ========================================================= */
function pick(obj, keys, fallback=null){
  for(const k of keys){
    if(obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] !== undefined && obj[k] !== null) return obj[k];
  }
  return fallback;
}

function normalizeAnalyzeResponse(data){
  // tenta achar o "analysis" em v√°rios formatos poss√≠veis
  const analysis = pick(data, ["analysis","analise","result","resultado"], {}) || {};

  // sinal (AZUL/ROXO/ROSA) pode vir em v√°rios nomes
  let sinal = String(pick(analysis, ["sinal","signal","tipo","type"], pick(data, ["sinal","signal"], "")) || "").toUpperCase().trim();

  // percentuais podem vir com ou sem % no nome
  const azul = Number(pick(analysis, ["azul_%","azul","blue","p_azul","pct_azul"], null));
  const roxo = Number(pick(analysis, ["roxo_%","roxo","purple","p_roxo","pct_roxo"], null));
  const rosa = Number(pick(analysis, ["rosa_%","rosa","pink","p_rosa","pct_rosa"], null));

  // total
  const total = Number(pick(data, ["total","count","qtd","quantidade"], null));

  // fallback: se n√£o veio sinal, decide pelo maior percentual (se existir)
  if(!sinal){
    const candidates = [
      {t:"AZUL", v: isFinite(azul) ? azul : -1},
      {t:"ROXO", v: isFinite(roxo) ? roxo : -1},
      {t:"ROSA", v: isFinite(rosa) ? rosa : -1},
    ].sort((a,b)=>b.v-a.v);
    if(candidates[0].v >= 0) sinal = candidates[0].t;
  }

  // confiabilidade: se existir, usa; se n√£o, usa o percentual do sinal como "conf"
  const confFromBackend = Number(pick(analysis, ["conf","confianca","confidence","probabilidade","prob"], pick(data, ["conf","confianca"], null)));
  let conf = isFinite(confFromBackend) ? confFromBackend : null;

  if(conf === null){
    if(sinal === "AZUL" && isFinite(azul)) conf = azul;
    if(sinal === "ROXO" && isFinite(roxo)) conf = roxo;
    if(sinal === "ROSA" && isFinite(rosa)) conf = rosa;
  }

  // multiplo (se o backend mandar)
  const mult = pick(analysis, ["mult","multiplo","multiplier","x"], pick(data, ["mult","multiplo"], null));

  return { total, sinal, azul, roxo, rosa, conf, mult, raw:data };
}

function formatPct(n){
  if(!isFinite(n)) return "-";
  return String(Math.round(n));
}

/** =========================================================
 *  Gr√°ficos (hist√≥rico real)
 *  ========================================================= */
let historyPage2 = JSON.parse(localStorage.getItem("historyPage2")||"[]");
let chartPage2Obj;

function loadHistoryPage2(){ updateChartPage2(); }

function updateChartPage2(){
  if(historyPage2.length>50) historyPage2=historyPage2.slice(-50);
  localStorage.setItem("historyPage2",JSON.stringify(historyPage2));
  if(chartPage2Obj) chartPage2Obj.destroy();
  chartPage2Obj = new Chart(chartPage2.getContext("2d"),{
    type:"line",
    data:{
      labels:historyPage2.map((_,i)=>i+1),
      datasets:[{
        data:historyPage2,
        borderColor:"#dc2626",
        backgroundColor:"rgba(220,38,38,.2)",
        tension:.4,
        fill:true
      }]
    },
    options:{plugins:{legend:{display:false}}, scales:{y:{min:0,max:100}}}
  });
}

/** =========================================================
 *  PASSO 3 ‚Äî Sinais reais (substitui simula√ß√£o)
 *  - Agora "GERAR SINAIS" usa o √∫ltimo resultado do /analyze
 *  ========================================================= */
let lastAnalyze = null;

function renderSignalsFromAnalyzeOnPage2(info){
  // cria 3 cards (AZUL/ROXO/ROSA) com percentuais, e destaca o sinal recomendado
  const cards = [
    {t:"AZUL", c:"cyan", pct: info.azul, mult: info.mult},
    {t:"ROXO", c:"purple", pct: info.roxo, mult: info.mult},
    {t:"ROSA", c:"pink", pct: info.rosa, mult: info.mult},
  ];

  signalsPage2.innerHTML = cards.map(x=>{
    const recommended = (info.sinal === x.t);
    const border = recommended ? `border-${x.c}-500/80` : `border-${x.c}-500/30`;
    const glow = recommended ? `style="box-shadow:0 0 25px rgba(220,38,38,.15);"` : "";
    return `<div class="signal-card glass border ${border}" ${glow}>
      <h3 class="font-bold text-${x.c}-400 mb-2">${recommended ? "‚úÖ " : ""}SINAL ${x.t}</h3>
      <div class="text-4xl font-black text-${x.c}-300 mb-2">√ó${x.mult ?? "--"}</div>
      <p>Probabilidade: <b>${formatPct(x.pct)}%</b></p>
    </div>`;
  }).join("");
}

function generateSignalsPage2(){
  if(!lastAnalyze){
    signalsPage2.innerHTML = `<div class="glass p-6 border border-red-600/20 text-center text-gray-300">
      Envie um hist√≥rico (PNG/JPG) e clique <b>ANALISAR</b> para gerar sinais reais.
    </div>`;
    return;
  }
  renderSignalsFromAnalyzeOnPage2(lastAnalyze);

  // Atualiza gr√°fico com "conf" (0-100). Se n√£o existir, usa 0.
  const confValue = isFinite(lastAnalyze.conf) ? Math.max(0, Math.min(100, Number(lastAnalyze.conf))) : 0;
  historyPage2.push(confValue);
  localStorage.setItem("historyPage2",JSON.stringify(historyPage2));
  updateChartPage2();
}

/** =========================================================
 *  VIP ‚Äî Reutiliza o mesmo /analyze, mas exibe apenas ROSA e atualiza chart VIP
 *  ========================================================= */
const vipUserData={user:"William",pass:"230220"};
function loginVIP(){
  const u=vipUser.value,p=vipPass.value;
  if(u===vipUserData.user && p===vipUserData.pass){
    document.getElementById("page2").classList.add("hidden");
    document.getElementById("page3").classList.remove("hidden");
    generateSignalsVIP();
  }else{
    alert("Usu√°rio ou senha VIP incorretos");
  }
}

let historyVIP = JSON.parse(localStorage.getItem("historyVIP")||"[]");
let chartVIPObj;

function updateChartVIP(){
  if(historyVIP.length>50) historyVIP=historyVIP.slice(-50);
  localStorage.setItem("historyVIP",JSON.stringify(historyVIP));
  if(chartVIPObj) chartVIPObj.destroy();
  chartVIPObj = new Chart(chartVIP.getContext("2d"),{
    type:"line",
    data:{
      labels:historyVIP.map((_,i)=>i+1),
      datasets:[{
        data:historyVIP,
        borderColor:"#dc2626",
        backgroundColor:"rgba(220,38,38,.2)",
        tension:.4,
        fill:true
      }]
    },
    options:{plugins:{legend:{display:false}}, scales:{y:{min:0,max:100}}}
  });
}

function generateSignalsVIP(){
  if(!lastAnalyze){
    signalsVIP.innerHTML = `<div class="glass p-6 border border-red-600/20 text-center text-gray-300">
      Envie um hist√≥rico VIP e clique <b>ANALISAR VIP</b> para gerar sinal real.
    </div>`;
    updateChartVIP();
    return;
  }

  const mult = lastAnalyze.mult ?? "--";
  const conf = isFinite(lastAnalyze.rosa) ? lastAnalyze.rosa : (isFinite(lastAnalyze.conf) ? lastAnalyze.conf : 0);

  signalsVIP.innerHTML = `<div class="signal-card glass border border-pink-500/60">
    <h3 class="font-bold text-pink-400 mb-2">SINAL ROSA (REAL)</h3>
    <div class="text-4xl font-black text-pink-300 mb-2">√ó${mult}</div>
    <p>Probabilidade: <b>${formatPct(conf)}%</b></p>
  </div>`;

  const confValue = isFinite(conf) ? Math.max(0, Math.min(100, Number(conf))) : 0;
  historyVIP.push(confValue);
  localStorage.setItem("historyVIP",JSON.stringify(historyVIP));
  updateChartVIP();
}

/** =========================================================
 *  Upload real (Render/FastAPI) + tratamento de erros
 *  ========================================================= */
async function postAnalyze(file){
  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch(`${BACKEND_URL}/analyze`, {
    method: "POST",
    body: formData
  });

  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status} - ${txt || "Erro ao chamar /analyze"}`);
  }
  return await res.json();
}

async function analyzeHistory(){
  const file = document.getElementById("uploadHistory").files[0];
  if(!file){ historyResult.innerHTML = "Nenhum arquivo selecionado"; return; }

  historyResult.innerHTML = "Analisando... aguarde.";

  try{
    const data = await postAnalyze(file);
    const info = normalizeAnalyzeResponse(data);
    lastAnalyze = info;

    historyResult.innerHTML = `
      Total: ${info.total ?? "-"} <br>
      Sinal (backend): <b>${info.sinal || "-"}</b> <br>
      Azul: ${formatPct(info.azul)}%, Roxo: ${formatPct(info.roxo)}%, Rosa: ${formatPct(info.rosa)}%
    `;

    // ap√≥s analisar, j√° gera sinais reais e atualiza gr√°fico
    generateSignalsPage2();

  }catch(err){
    historyResult.innerHTML = `Falha: ${err.message}<br><span class="text-gray-400">Dica: isso costuma ser CORS ou URL errado.</span>`;
  }
}

async function analyzeHistoryVIP(){
  const file = document.getElementById("uploadHistoryVIP").files[0];
  if(!file){ historyResultVIP.innerHTML = "Nenhum arquivo selecionado"; return; }

  historyResultVIP.innerHTML = "Analisando VIP... aguarde.";

  try{
    const data = await postAnalyze(file);
    const info = normalizeAnalyzeResponse(data);
    lastAnalyze = info;

    historyResultVIP.innerHTML = `
      Total: ${info.total ?? "-"} <br>
      Sinal (backend): <b>${info.sinal || "-"}</b> <br>
      Azul: ${formatPct(info.azul)}%, Roxo: ${formatPct(info.roxo)}%, Rosa: ${formatPct(info.rosa)}%
    `;

    generateSignalsVIP();

  }catch(err){
    historyResultVIP.innerHTML = `Falha: ${err.message}<br><span class="text-gray-400">Dica: isso costuma ser CORS ou URL errado.</span>`;
  }
}
</script>
</body>
      </html>
